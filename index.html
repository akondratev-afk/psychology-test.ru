<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Интегральный тип личности — опрос</title>

  <style>
    :root{
      --bg:#fafafa; --card:#fff; --bd:#e6e6e6; --txt:#111; --muted:#666;
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:980px;margin:24px auto;padding:0 12px}

    .header{
      background:var(--card);
      border:1px solid var(--bd);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
    }
    h1{margin:0 0 6px;font-size:20px}
    .sub{margin:0;color:var(--muted);line-height:1.35}

    .toprow{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-top:12px
    }
    .pill{border:1px solid var(--bd);border-radius:999px;padding:8px 10px;background:#fff;color:var(--muted)}
    .bar{flex:1;min-width:220px;height:10px;border:1px solid var(--bd);border-radius:999px;overflow:hidden;background:#efefef}
    .bar > div{height:100%;width:0%;background:#111}
    .namebox{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .namebox input{border:1px solid var(--bd);border-radius:12px;padding:10px 12px;min-width:220px}

    /* STAGE */
    .stage{
      margin-top:14px;
      background:var(--card);
      border:1px solid var(--bd);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
      min-height: 420px;
    }
    /* В режиме результатов — высота под экран */
    .stage.stage--results{
      height: calc(100vh - 220px);
      min-height: 560px;
    }

    /* PANEL */
    .panel{
      position:absolute; inset:0;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      will-change: transform, opacity;
      background:var(--card);
      min-height: 0;
    }
    .panel.panel--question{ padding-bottom: 92px; }
    .panel.panel--results{ padding-bottom: 16px; }

    .qhead{display:flex;gap:10px;align-items:flex-start}
    .qnum{
      min-width:40px;height:40px;border:1px solid var(--bd);border-radius:12px;
      display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:800
    }
    .qtext{font-weight:800;line-height:1.35;font-size:16px}

    .opts{display:grid;gap:10px;margin-top:2px}
    .opt{
      border:1px solid var(--bd);
      border-radius:14px;
      padding:12px 12px;
      cursor:pointer;
      display:flex; gap:10px; align-items:flex-start;
      user-select:none;
      background:#fff;
    }
    .opt:hover{background:#fcfcfc}
    .opt input{margin-top:3px}
    .opt .lbl{line-height:1.35}

    .msg{color:#b00020;font-weight:800;display:none}
    .muted{color:var(--muted)}
    .small{font-size:12px}

    /* NAV (вопросы — приклеено снизу) */
    .nav{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:14px 16px 16px;
      border-top:1px solid var(--bd);
      align-items:center; justify-content:space-between;
      background:linear-gradient(to bottom, rgba(255,255,255,.6), rgba(255,255,255,1));
    }
    .panel--question .nav{
      position:absolute;
      left:0;right:0;bottom:0;
    }
    /* NAV (результаты — не перекрывает сетку) */
    .panel--results .nav{
      position:relative;
      left:auto;right:auto;bottom:auto;
      margin-top:6px;
    }

    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:1px solid var(--bd);
      background:#fff;
      border-radius:14px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:700;
    }
    button:hover{background:#f6f6f6}
    button.primary{background:#111;color:#fff;border-color:#111}
    button.primary:hover{background:#000}
    button:disabled{opacity:.45;cursor:not-allowed}

    /* Анимации */
    .enter-right{transform:translateX(18px);opacity:0}
    .enter-left{transform:translateX(-18px);opacity:0}
    .active{transform:translateX(0);opacity:1;transition:transform .26s ease, opacity .26s ease}
    .exit-left{transform:translateX(-18px);opacity:0;transition:transform .20s ease, opacity .20s ease}
    .exit-right{transform:translateX(18px);opacity:0;transition:transform .20s ease, opacity .20s ease}

    /* ===== РЕЗУЛЬТАТЫ: дизайн “пилюль” как в PDF ===== */
    .result-title{
      margin:0 0 6px;
      font-size:18px;
      font-weight:900;
    }
    .result-meta{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:10px;
      margin-top:12px;

      flex: 1 1 auto;
      overflow:auto;
      min-height:0;
      padding:2px 2px 8px;
    }

    .cell{
      border:1px solid var(--bd);
      border-radius:14px;
      padding:10px 10px;
      min-height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:13px;
      color:var(--txt);
      background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      white-space:nowrap;
      user-select:text;
    }
    .cell:hover{background:#fcfcfc}

    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(10, 1fr);} }
    @media (max-width: 900px){  .grid{ grid-template-columns: repeat(8, 1fr);} }
    @media (max-width: 700px){  .grid{ grid-template-columns: repeat(6, 1fr);} }
    @media (max-width: 520px){  .grid{ grid-template-columns: repeat(4, 1fr);} }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <h1>Интегральный тип личности</h1>

      <div class="toprow">
        <div class="pill">Вопрос: <b id="pos">1</b> / <b id="total">0</b></div>
        <div class="bar" aria-label="Прогресс"><div id="barFill"></div></div>

        <div class="namebox">
          <span class="muted small">Имя (необязательно):</span>
          <input id="participant" type="text" placeholder="Например: Иван" />
        </div>
      </div>
    </div>

    <div class="stage" id="stage"></div>
  </div>

  <!-- jsPDF нужен только как контейнер PDF, картинку рисуем на canvas -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
(() => {
  const OPTIONS = [
    { key: "plus",  label: "Чаще так", value:  1, symbol: "+"   },
    { key: "pm",    label: "Бывает так, но не всегда", value: 0, symbol: "+/-" },
    { key: "minus", label: "Чаще не так", value: -1, symbol: "-" },
  ];

  const QUESTIONS = [
    { id: 1, text: "Я просыпаюсь не сразу, и даже после того, как встану, еще долго могу находиться в полусонном состоянии." },
    { id: 2, text: "Мне нравятся комплименты, мне нравится, когда меня хвалят." },
    { id: 3, text: "Если у меня что-то заболит, то это беспокоит меня долго, даже когда мне станет легче, то сохраняется тревога по поводу здоровья." },
    { id: 4, text: "Я предпочел(ла) бы иметь пассивный доход, чтобы работать мало и иметь много свободного времени." },
    { id: 5, text: "Когда я голодный(ая), я беру (накладываю) себе еды больше, чем, оказывается, - могу съесть." },
    { id: 6, text: "После споров, конфликтов я думаю, что скорее всего я был (а) в чем-то не прав (а)." },
    { id: 7, text: "В отношениях с людьми я стараюсь избегать каких-либо обязательств." },
    { id: 8, text: "Люди в большинстве своем безответственны, поэтому чувствую желание их контролировать." },
    { id: 9, text: "Бывает, что мне трудно понять, хочу ли я есть и что именно хотелось бы съесть." },
    { id: 10, text: "Я думаю, что я очень хороший человек." },
    { id: 11, text: "Я очень серьезно отношусь к традициям моей семьи, моей культуры, религии, нации." },
    { id: 12, text: "Я чувствую, что в большинстве своем люди дружественны или равнодушны ко мне." },
    { id: 13, text: "В личных отношениях я беру инициативу на себя, предпочитаю быть ведущим, а не ведомым." },
    { id: 14, text: "Я чувствую, что, скорее всего, я не очень хороший человек." },
    { id: 15, text: "Даже если я переел, дискомфорт в животе у меня практически отсутствует или длится недолго." },
    { id: 16, text: "Так получается, что в жизни я вынужден организовывать других людей, руководить ими, отвечать за их поступки." },
    { id: 17, text: "На стресс я реагирую несколько замедленно, в такие напряженные моменты мне хочется просто закрыть глаза и ничего не видеть, и не слышать." },
    { id: 18, text: "Я думаю, что большинство людей восхищается мной." },
    { id: 19, text: "Я считаю, что интересы всего общества, коллектива важнее, чем интересы каждого человека в отдельности." },
    { id: 20, text: "Детям для развития надо предоставлять как можно больше свободы и ни в чем не ограничивать их." },
    { id: 21, text: "Я обостренно реагирую на неожиданные прикосновения, щекотку, - вздрагиваю, иногда даже пугаюсь." },
    { id: 22, text: "Я думаю, что не люблю себя." },
    { id: 23, text: "Если у меня что-то заболит, то я не буду долго мучиться и приму какое-нибудь лекарство." },
    { id: 24, text: "Я убежден, что в окружающем меня мире очень многое устроено не так, как должно быть." },
    { id: 25, text: "Я не сразу могу понять – уже заболел(а) или еще нет, иногда самочувствие как бы балансирует на грани болезни." },
    { id: 26, text: "Я считаю, что я намного способнее и увереннее большинства людей." },
    { id: 27, text: "Я считаю, что причины всех проблем человека нужно искать в его прошлом." },
    { id: 28, text: "Мне не нравится контролировать других людей." },
    { id: 29, text: "Если я узнаю что-то новое, я сразу же начинаю строить планы, как я смогу применить эту информацию в будущем." },
    { id: 30, text: "Я страдаю из-за своего чувства долга перед другими людьми." },
    { id: 31, text: "Когда у меня возникают проблемы или физическое недомогание, я могу принять решение изменить образ жизни, не переедать, заняться физкультурой, но, когда дискомфорт проходит, я легко откладываю данное решение на потом." },
    { id: 32, text: "Я не терплю, когда меня не дослушивают до конца, не дают мне договорить, высказаться." },
    { id: 33, text: "Я не сразу реагирую на перемены вокруг меня (погоды, новую обстановку, новых людей), мне надо некоторое время осмотреться, привыкнуть, адаптироваться." },
    { id: 34, text: "Я не сомневаюсь, что могу добиться в жизни всего, чего захочу." },
    { id: 35, text: "Если меня что-то вывело из равновесия, то я очень долго не могу прийти в себя." },
    { id: 36, text: "Меня считают добрым и беззлобным человеком." },
    { id: 37, text: "Меня очень легко вывести из равновесия, я легко взрываюсь, раздражаюсь." },
    { id: 38, text: "Мне подходит работа исполнителя под чьим-то руководством." },
    { id: 39, text: "Я не могу долго концентрировать внимание на каком-то одном деле, мысли, мне необходимо расслабиться и отвлечься." },
    { id: 40, text: "Людям нельзя давать свободу, они не знают, что с ней делать." },
    { id: 41, text: "В общении, мне бывает трудно сразу же сформулировать свои мысли, подобрать правильные слова, бывает, что понимание того, что нужно было сказать или сделать приходит позже." },
    { id: 42, text: "Я не могу делать того, что мне не интересно, что я не хочу делать." },
    { id: 43, text: "После перенесенного заболевания процесс выздоровления у меня затягивается, трудно вернуться к первоначальному здоровому состоянию." },
    { id: 44, text: "Я не считаю, что должен брать на себя ответственность за других людей." },
    { id: 45, text: "Я очень легко и быстро завожу новые знакомства, влюбляюсь." },
    { id: 46, text: "Я грустный человек" },
    { id: 47, text: "Я легко забываю людей." },
    { id: 48, text: "Если близкие не разделяют моих взглядов на жизнь, то я стараюсь убедить их в своей правоте." },
    { id: 49, text: "Я не решаюсь внутри себя давать оценки людям с первого взгляда." },
    { id: 50, text: "Я считаю, что я - великий человек." },
    { id: 51, text: "Если я злоупотреблю алкоголем, то меня еще долго мучают последствия этого (головная боль, тошнота и т.п.)." },
    { id: 52, text: "Меня трудно чем-нибудь удивить." },
    { id: 53, text: "Если я иду в магазин, то обязательно что-нибудь куплю. Бывает, что я потом понимаю, что мне это совсем не нужно, или не нужно в таком количестве." },
    { id: 54, text: "Я чувствую себя виноватым (ой) даже без видимой на то причины." },
    { id: 55, text: "После сильных конфликтов или переживаний я чувствую потребность лечь спать, поесть, выпить, забыться или отвлечься другим способом." },
    { id: 56, text: "Если я вижу недостатки в других людях, то я чувствую себя должным исправить их." },
    { id: 57, text: "Бывает, что я опаздываю из-за того, что не могу оторваться от текущих занятий." },
    { id: 58, text: "Мне нравится работать только на себя, я стремлюсь подороже продать свои таланты и способности." },
    { id: 59, text: "В личных отношениях я очень сильно привязываюсь к другим людям." },
    { id: 60, text: "У меня нет потребности менять что-либо вокруг." },
    { id: 61, text: "Я схватываю информацию «на лету», бывает, что мне еще что-то не договорили, а мне уже все понятно." },
    { id: 62, text: "Я недоволен(на) собой" },
    { id: 63, text: "Я не чувствую сильной привязанности к местам, где жил когда-то, к людям с которыми тесно общался." },
    { id: 64, text: "Сознаюсь, что я ревнивый человек, но для ревности всегда есть внешние причины – «Дыма без огня не бывает!»." },
    { id: 65, text: "Мне трудно познакомиться первым, начать разговор, проявить инициативу в общении." },
    { id: 66, text: "Я могу позволить себе гораздо больше, чем большинство людей." },
    { id: 67, text: "Я не смогу успокоиться, пока не закончу дело, которое начал." },
    { id: 68, text: "Если кто-то не согласен со мной, я не чувствую сильной потребности доказывать свою правоту." },
    { id: 69, text: "У меня в голове заранее проигрываются детали будущих событий, представляются различные версии их развития, строятся прогнозы." },
    { id: 70, text: "Мне неловко, когда меня благодарят или хвалят." },
    { id: 71, text: "Я засыпаю мгновенно." },
    { id: 72, text: "Мои обиды или обвинения никогда не бывают беспочвенными." },
    { id: 73, text: "Прежде чем начать выполнять работу, мне необходимо сначала получить подробные инструкции, основательно подготовиться, собраться с мыслями и силами." },
    { id: 74, text: "Меня не сильно заботит то, как я выгляжу в глазах других людей." },
    { id: 75, text: "После стресса я очень долго не могу прийти в себя." },
    { id: 76, text: "В первую очередь, я стремлюсь обеспечить себе стабильность, комфорт и спокойствие." },
    { id: 77, text: "У меня так быстро возникают новые идеи, что многие из них я не успеваю запоминать." },
    { id: 78, text: "Я чувствую готовность принести себя в жертву ради других людей." },
    { id: 79, text: "Внешняя среда, люди, погода и т.д. мало влияют на мое самочувствие и настроение." },
    { id: 80, text: "Если человек хоть раз обманул меня, то я никогда больше не смогу доверять ему." },
    { id: 81, text: "Принимая решение, я руководствуюсь правилом «Семь раз отмерь, один раз отрежь!»." },
    { id: 82, text: "Я считаю, что у меня нет недостатков." },
    { id: 83, text: "Бывает, что я не могу остановиться в мыслях, чувствах, поступках, даже если понимаю, что это необходимо." },
    { id: 84, text: "Мне гораздо легче разрешить, чем запретить." },
    { id: 85, text: "У меня часто бывает предвидение, предчувствие событий, я могу чувствовать на расстоянии то, что другие не чувствуют или не замечают." },
    { id: 86, text: "Я чувствую, что я приношу близким горе и страдание." },
    { id: 87, text: "Я недолго переживаю, - как из-за неприятных, так и из-за радостных событий жизни." },
    { id: 88, text: "Мне плохо из-за того, что меня мало кто понимает." },
    { id: 89, text: "Я стараюсь не загружать себя мыслями о будущем, жить настоящим." },
    { id: 90, text: "У меня так много различных желаний, что я не успеваю их все удовлетворить." },
    { id: 91, text: "У меня возникает желание переделать, исправить что-то, что уже прожито в прошлом." },
    { id: 92, text: "Для меня лучше «плохой мир», чем «хорошая», пусть даже справедливая война." },
    { id: 93, text: "Чтобы начать выполнять дело, работу, я не нуждаюсь в подробном инструктировании, мне достаточно ухватить суть задания." },
    { id: 94, text: "Я все время кому-то что-то должен и у меня такое чувство, что мне никогда не расплатиться с этими долгами." },
    { id: 95, text: "Я легко могу бросить дело, даже если оно еще не закончено, и не буду переживать по этому поводу." },
    { id: 96, text: "В личных отношениях я никогда не прощаю предательства." },
    { id: 97, text: "Бывает, что я испытываю сильную потребность бесцельно бродить по городу, по улицам, по магазинам просто так, разглядывая окружающее (дома, людей, витрины, товары и т.д.)." },
    { id: 98, text: "Я жизнерадостный человек." },
    { id: 99, text: "В общении я предпочту иметь узкий круг хорошо проверенных людей широкому кругу новых знакомых по поговорке – «старый друг лучше новых двух»." },
    { id: 100, text: "В обучении большая ответственность за его результат лежит на ученике, не «учитель учит», а «ученик учится»." },
    { id: 101, text: "Заболеваю я быстро и внезапно: только что не было ничего и вдруг уже что-то болит, повышается температура, появляется сильное недомогание." },
    { id: 102, text: "Я чувствую себя очень неуверенным человеком." },
    { id: 103, text: "Я скептически отношусь к общественным устоям, традициям, нормам." },
    { id: 104, text: "Если я не оставляю кого-то в покое, то это потому что я забочусь о благе этого человека или других людей." },
    { id: 105, text: "Бывает, что мне очень трудно заставить себя встать с кровати, одеться, собраться, заняться какими-либо делами." },
    { id: 106, text: "Я практически не гружусь ответственностью перед другими людьми." },
    { id: 107, text: "Я долго лежу, ворочаюсь в кровати, прежде чем засну." },
    { id: 108, text: "Я не требовательный человек, я снисходительно отношусь к чужим слабостям и недостаткам." },
    { id: 109, text: "В делах я люблю рисковать, принимая неожиданные, даже авантюрные решения." },
    { id: 110, text: "Мне все в жизни дается большим трудом." },
    { id: 111, text: "Я считаю, что интересы отдельного человека важнее, чем интересы общества, коллектива." },
    { id: 112, text: "Меня очень напрягают ситуации, которые я не могу контролировать." },
    { id: 113, text: "Я стараюсь во всем проявлять осторожность, не принимать скоропалительных решений, оценить все риски." },
    { id: 114, text: "Я не чувствую себя виноватым." },
    { id: 115, text: "Я не могу полностью переключиться на новое дело, пока не доведены до конца текущие дела." },
    { id: 116, text: "Я спокойный, рассудительный человек." },
    { id: 117, text: "У меня обостренное восприятие запахов, звуков, бывает, что меня они раздражают, а других вокруг – нет." },
    { id: 118, text: "Мне кажется, что я довольно неудачливый человек." },
    { id: 119, text: "Я не вижу смысла копаться в прошлом, анализировать свои и чужие ошибки." },
    { id: 120, text: "Меня обижает, что в жизни я получаю благодарности от людей гораздо меньше, чем я того заслуживаю." },
    { id: 121, text: "Иногда мне хочется, чтобы время просто остановилось и ничего вокруг не происходило." },
    { id: 122, text: "Я знаю, что от природы мне даны большие, чем другим способности и таланты." },
    { id: 123, text: "Мне трудно заканчивать дела, отношения." },
    { id: 124, text: "Я могу понять любого." },
    { id: 125, text: "Я просыпаюсь мгновенно." },
    { id: 126, text: "Меня беспокоит, что я плохо выгляжу в глазах других людей." },
    { id: 127, text: "Я легко отвлекаюсь, забываю о своих обещаниях кому-то или собственных планах." },
    { id: 128, text: "Я не могу полностью доверять другим людям." },
  ];

  const LS_ANS = "survey128_answers_v_site_final_auto";
  const LS_NAME = "survey128_participant_v_site_final_auto";

  const stage = document.getElementById("stage");
  const posEl = document.getElementById("pos");
  const totalEl = document.getElementById("total");
  const barFill = document.getElementById("barFill");
  const participantEl = document.getElementById("participant");

  totalEl.textContent = String(QUESTIONS.length);

  participantEl.value = localStorage.getItem(LS_NAME) || "";
  participantEl.addEventListener("input", () => localStorage.setItem(LS_NAME, participantEl.value || ""));

  let answers = loadAnswers();
  let idx = 0;
  let currentPanel = null;

  // автопереход: таймер + защита от случайных двойных срабатываний
  let autoAdvanceTimer = null;
  const AUTO_ADVANCE_DELAY_MS = 220;

  function clearAutoAdvance(){
    if(autoAdvanceTimer){
      clearTimeout(autoAdvanceTimer);
      autoAdvanceTimer = null;
    }
  }

  function scheduleAutoAdvance(){
    clearAutoAdvance();
    autoAdvanceTimer = setTimeout(() => {
      autoAdvanceTimer = null;
      // если пользователь уже ушёл на результаты — ничего не делаем
      if(stage.classList.contains("stage--results")) return;

      // на последнем вопросе — показываем результаты
      if(idx === QUESTIONS.length - 1){
        renderResults("right");
      } else {
        renderQuestion(idx + 1, "right");
      }
    }, AUTO_ADVANCE_DELAY_MS);
  }

  function loadAnswers(){
    try{
      const raw = localStorage.getItem(LS_ANS);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      return (obj && typeof obj === "object") ? obj : {};
    }catch{ return {}; }
  }
  function saveAnswers(){ localStorage.setItem(LS_ANS, JSON.stringify(answers)); }

  function progress(){
    const done = QUESTIONS.reduce((acc,q)=> acc + (answers[q.id] ? 1 : 0), 0);
    barFill.style.width = Math.round((done / QUESTIONS.length) * 100) + "%";
  }

  function symbolFor(id){
    const key = answers[id];
    const opt = OPTIONS.find(o => o.key === key);
    return opt ? opt.symbol : "";
  }

  function firstMissing(){
    for(const q of QUESTIONS){
      if(!answers[q.id]) return q.id;
    }
    return null;
  }

  function safeName(){
    return (participantEl.value || "participant").replaceAll(/[^\w\d\-_.]+/g,"_");
  }

  function downloadFile(filename, content, mime){
    const blob = new Blob([content], { type:mime });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function makeCSV(){
    const bom = "\ufeff";
    const rows = [["id","symbol"], ...QUESTIONS.map(q => [q.id, symbolFor(q.id)])];
    return bom + rows.map(r => r.map(v => `"${String(v ?? "").replaceAll('"','""')}"`).join(",")).join("\n");
  }

  // PDF без “белиберды”: рисуем canvas (кириллица ок), вставляем картинкой в PDF
  function downloadPDF(){
    const miss = firstMissing();
    if(miss !== null){
      alert(`Не все вопросы отвечены. Первый пропуск: №${miss}`);
      return;
    }
    if(!window.jspdf || !window.jspdf.jsPDF){
      alert("PDF-библиотека не загрузилась (jspdf). Проверь интернет/доступ к CDN.");
      return;
    }

    const { jsPDF } = window.jspdf;

    const Wmm = 297, Hmm = 210; // A4 landscape
    const dpi = 150;
    const mmToPx = (mm) => Math.round(mm / 25.4 * dpi);
    const W = mmToPx(Wmm);
    const H = mmToPx(Hmm);

    const canvas = document.createElement("canvas");
    canvas.width = W;
    canvas.height = H;
    const ctx = canvas.getContext("2d");

    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, W, H);

    const margin = Math.round(W * 0.02);
    const dateStr = new Date().toLocaleString("ru-RU");
    const name = (participantEl.value || "").trim();
    const header = name ? `${name} — ${dateStr}` : dateStr;

    let headerFont = 28;
    ctx.fillStyle = "#111111";
    ctx.textBaseline = "top";
    ctx.font = `700 ${headerFont}px Arial`;

    while (ctx.measureText(header).width > (W - margin * 2) && headerFont > 14) {
      headerFont -= 1;
      ctx.font = `700 ${headerFont}px Arial`;
    }
    ctx.fillText(header, margin, margin);

    const headerH = headerFont + 18;
    const gridTop = margin + headerH + 10;

    const cols = 16;
    const rows = 8;
    const gridW = W - margin * 2;
    const gridH = H - gridTop - margin;
    const cellW = gridW / cols;
    const cellH = gridH / rows;

    ctx.strokeStyle = "#111111";
    ctx.lineWidth = 2;

    let cellFont = 18;
    ctx.font = `700 ${cellFont}px Arial`;
    const sample = "128) +/-";
    while (ctx.measureText(sample).width > (cellW * 0.90) && cellFont > 10) {
      cellFont -= 1;
      ctx.font = `700 ${cellFont}px Arial`;
    }

    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    for (let i = 0; i < 128; i++) {
      const qId = i + 1;
      const sym = symbolFor(qId);
      const txt = `${qId}) ${sym}`;

      const r = Math.floor(i / cols);
      const c = i % cols;

      const x = margin + c * cellW;
      const y = gridTop + r * cellH;

      ctx.strokeRect(x, y, cellW, cellH);
      ctx.fillText(txt, x + cellW / 2, y + cellH / 2);
    }

    const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });
    const img = canvas.toDataURL("image/jpeg", 0.92);
    doc.addImage(img, "JPEG", 0, 0, Wmm, Hmm);

    doc.save(`survey_results_${safeName()}.pdf`);
  }

  function transitionTo(newPanel, dir){
    newPanel.classList.add(dir === "right" ? "enter-right" : "enter-left");
    stage.appendChild(newPanel);

    requestAnimationFrame(() => {
      newPanel.classList.add("active");
      newPanel.classList.remove("enter-right","enter-left");
    });

    const old = currentPanel;
    currentPanel = newPanel;

    if(old){
      old.classList.add(dir === "right" ? "exit-left" : "exit-right");
      setTimeout(() => old?.parentNode?.removeChild(old), 220);
    }
  }

  function buildQuestionPanel(q){
    const panel = document.createElement("div");
    panel.className = "panel panel--question";

    const head = document.createElement("div");
    head.className = "qhead";

    const num = document.createElement("div");
    num.className = "qnum";
    num.textContent = String(q.id);

    const text = document.createElement("div");
    text.className = "qtext";
    text.textContent = q.text;

    head.appendChild(num);
    head.appendChild(text);

    const opts = document.createElement("div");
    opts.className = "opts";

    const saved = answers[q.id] || null;

    OPTIONS.forEach(opt => {
      const label = document.createElement("label");
      label.className = "opt";

      const input = document.createElement("input");
      input.type = "radio";
      input.name = `q${q.id}`;
      input.value = opt.key;
      if(saved === opt.key) input.checked = true;

      input.addEventListener("change", () => {
        answers[q.id] = opt.key;
        saveAnswers();
        progress();

        msgEl.style.display = "none";
        msgEl.textContent = "";

        // ✅ Автопереход на следующий вопрос
        scheduleAutoAdvance();
      });

      const span = document.createElement("div");
      span.className = "lbl";
      span.textContent = opt.label;

      label.appendChild(input);
      label.appendChild(span);
      opts.appendChild(label);
    });

    const msgEl = document.createElement("div");
    msgEl.className = "msg";

    const nav = document.createElement("div");
    nav.className = "nav";

    const left = document.createElement("div");
    left.className = "muted small";
    left.textContent = "После выбора ответа произойдёт автопереход. Можно вернуться и изменить ответ.";

    const btns = document.createElement("div");
    btns.className = "btns";

    const prevBtn = document.createElement("button");
    prevBtn.textContent = "Предыдущий вопрос";
    prevBtn.disabled = (idx === 0);
    prevBtn.addEventListener("click", () => { clearAutoAdvance(); go(-1); });

    const nextBtn = document.createElement("button");
    nextBtn.className = "primary";
    nextBtn.textContent = (idx === QUESTIONS.length - 1) ? "Показать результаты" : "Следующий вопрос";
    nextBtn.addEventListener("click", () => { clearAutoAdvance(); go(+1); });

    const resetBtn = document.createElement("button");
    resetBtn.textContent = "Сбросить";
    resetBtn.addEventListener("click", () => {
      if(!confirm("Сбросить все ответы?")) return;
      clearAutoAdvance();
      answers = {};
      localStorage.removeItem(LS_ANS);
      idx = 0;
      renderQuestion(0, "left");
      progress();
    });

    btns.appendChild(prevBtn);
    btns.appendChild(nextBtn);
    btns.appendChild(resetBtn);

    nav.appendChild(left);
    nav.appendChild(btns);

    panel.appendChild(head);
    panel.appendChild(opts);
    panel.appendChild(msgEl);
    panel.appendChild(nav);

    panel._msgEl = msgEl;
    return panel;
  }

  function ensureAnswered(panel){
    const q = QUESTIONS[idx];
    if(!answers[q.id]){
      panel._msgEl.style.display = "block";
      panel._msgEl.textContent = "Пожалуйста, выберите один вариант ответа.";
      return false;
    }
    return true;
  }

  function renderQuestion(newIdx, dir){
    clearAutoAdvance();
    stage.classList.remove("stage--results");
    idx = newIdx;
    posEl.textContent = String(idx + 1);

    const q = QUESTIONS[idx];
    const panel = buildQuestionPanel(q);
    transitionTo(panel, dir);
    progress();
  }

  function renderResults(dir){
    clearAutoAdvance();
    const miss = firstMissing();
    if(miss !== null){
      if(currentPanel && currentPanel._msgEl){
        currentPanel._msgEl.style.display = "block";
        currentPanel._msgEl.textContent = `Не все вопросы отвечены. Первый пропуск: №${miss}`;
      }
      return;
    }

    stage.classList.add("stage--results");

    const panel = document.createElement("div");
    panel.className = "panel panel--results";

    const h2 = document.createElement("h2");
    h2.className = "result-title";
    h2.textContent = "Результаты";

    const meta = document.createElement("p");
    meta.className = "result-meta";
    const ts = new Date().toISOString().replace("T"," ").slice(0,19);
    meta.textContent = `Участник: ${participantEl.value || "—"} • ${ts}`;

    const grid = document.createElement("div");
    grid.className = "grid";

    for(const q of QUESTIONS){
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.textContent = `${q.id}) ${symbolFor(q.id)}`;
      grid.appendChild(cell);
    }

    const nav = document.createElement("div");
    nav.className = "nav";

    const left = document.createElement("div");
    left.className = "muted small";
    left.textContent = "Таблица: номер вопроса + символ ответа. Кнопки скачивания ниже.";

    const btns = document.createElement("div");
    btns.className = "btns";

    const backBtn = document.createElement("button");
    backBtn.textContent = "Вернуться";
    backBtn.addEventListener("click", () => renderQuestion(idx, "left"));

    const pdfBtn = document.createElement("button");
    pdfBtn.className = "primary";
    pdfBtn.textContent = "Скачать PDF (1 страница)";
    pdfBtn.addEventListener("click", downloadPDF);

    const csvBtn = document.createElement("button");
    csvBtn.textContent = "Скачать CSV";
    csvBtn.addEventListener("click", () => {
      downloadFile(`survey_results_${safeName()}.csv`, makeCSV(), "text/csv;charset=utf-8");
    });

    const resetBtn = document.createElement("button");
    resetBtn.textContent = "Сбросить";
    resetBtn.addEventListener("click", () => {
      if(!confirm("Сбросить все ответы?")) return;
      clearAutoAdvance();
      answers = {};
      localStorage.removeItem(LS_ANS);
      idx = 0;
      renderQuestion(0, "left");
      progress();
    });

    btns.appendChild(backBtn);
    btns.appendChild(pdfBtn);
    btns.appendChild(csvBtn);
    btns.appendChild(resetBtn);

    nav.appendChild(left);
    nav.appendChild(btns);

    panel.appendChild(h2);
    panel.appendChild(meta);
    panel.appendChild(grid);
    panel.appendChild(nav);

    transitionTo(panel, dir);
    progress();
  }

  function go(step){
    clearAutoAdvance();
    const nextIndex = idx + step;

    if(step > 0){
      if(!ensureAnswered(currentPanel)) return;
      if(idx === QUESTIONS.length - 1){
        renderResults("right");
        return;
      }
    }

    if(nextIndex < 0 || nextIndex >= QUESTIONS.length) return;
    renderQuestion(nextIndex, step > 0 ? "right" : "left");
  }

  // старт
  renderQuestion(0, "right");
  progress();
})();
</script>
</body>
</html>
